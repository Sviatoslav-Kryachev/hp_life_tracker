<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='70' fill='%23333' font-weight='bold'%3EüéØ‚è±Ô∏è%3C/text%3E%3C/svg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- CSS Modules -->
    <link rel="stylesheet" href="components/common/animations.css">
    <link rel="stylesheet" href="components/common/buttons.css">
    <link rel="stylesheet" href="components/common/cards.css">
    <link rel="stylesheet" href="components/common/forms.css">
    <link rel="stylesheet" href="components/common/scrollbars.css">
    <link rel="stylesheet" href="components/common/widget-base.css">
    <link rel="stylesheet" href="components/common/gradients.css">
    <link rel="stylesheet" href="components/common/visibility.css">
    <link rel="stylesheet" href="components/common/typography.css">
    <link rel="stylesheet" href="components/common/colors.css">
    <link rel="stylesheet" href="components/common/icons.css">
    <link rel="stylesheet" href="components/common/utilities.css">
    <link rel="stylesheet" href="components/layout/grid.css">
    <link rel="stylesheet" href="components/layout/spacing.css">
    <link rel="stylesheet" href="components/layout/responsive.css">
    <link rel="stylesheet" href="style.css?v=58">
    <title>HP Life Tracker</title>
    <!-- Visibility styles –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ components/common/visibility.css -->
</head>

<body class="bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 min-h-screen">
    <!-- Auth initialization script –≤—ã–Ω–µ—Å–µ–Ω –≤ js/app_auth_init.js -->

    <!-- AUTH SECTION Component Container -->
    <div id="auth-section"></div>

    <!-- MAIN APP (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫–æ–≥–¥–∞ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω) -->
    <div id="app-section" class="hidden">
        <!-- Header Component Container -->
        <div id="header-container"></div>

        <!-- App Layout Component Container (layout –≤—ã–Ω–µ—Å–µ–Ω –≤ components/layout/app-layout.html) -->
        <div id="app-layout-container"></div>

        <!-- Footer Component Container -->
        <div id="footer-container"></div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ components.js -->

    <!-- Bottom Navigation Component Container -->
    <div id="bottom-navigation-container"></div>

    <!-- Component Loader -->
    <script src="js/components.js"></script>
           <!-- JavaScript Modules (–∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ) -->
           <script src="js/app_utils.js"></script>
           <script src="js/app_auth_init.js"></script>
           <script src="js/app_auth.js"></script>
           <script src="js/app_activities.js"></script>
           <script src="js/app_rewards.js"></script>
           <script src="js/app_history.js"></script>
           <script src="js/app_wallet.js"></script>
           <script src="js/app_goals.js"></script>
           <script src="js/app_categories.js"></script>
           <!-- Main App Script (–æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –µ—â–µ –Ω–µ –º–æ–¥—É–ª—è—Ä–∏–∑–æ–≤–∞–Ω) -->
           <script src="js/app.js?v=52"></script>
    <!-- Social Features -->
    <script src="js/app_social.js"></script>
    <!-- Load Components -->
    <script>
        // –§–ª–∞–≥ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ app-section
        let appComponentsLoaded = false;
        
        // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ app-section
        async function loadAppComponents() {
            if (appComponentsLoaded) return;
            
            const appSection = document.getElementById('app-section');
            if (!appSection) return;
            
            try {
                await loadComponents([
                    { name: 'header', selector: '#header-container' },
                    { name: 'app-layout', selector: '#app-layout-container', path: 'layout/app-layout' },
                    { name: 'footer', selector: '#footer-container' },
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∏–¥–∂–µ—Ç—ã
                    { name: 'widget-today', selector: '#widget-today-container', path: 'widgets/widget-today' },
                    { name: 'widget-calendar', selector: '#widget-calendar-container', path: 'widgets/widget-calendar' },
                    { name: 'widget-progress', selector: '#widget-progress-container', path: 'widgets/widget-progress' },
                    { name: 'widget-streak', selector: '#widget-streak-container', path: 'widgets/widget-streak' },
                    { name: 'widget-category-stats', selector: '#widget-category-stats-container', path: 'widgets/widget-category-stats' },
                    { name: 'widget-goals', selector: '#widget-goals-container', path: 'widgets/widget-goals' },
                    { name: 'widget-recommendations', selector: '#widget-recommendations-container', path: 'widgets/widget-recommendations' },
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ —Å–µ–∫—Ü–∏–∏
                    { name: 'section-activities', selector: '#section-activities-container', path: 'sections/section-activities' },
                    { name: 'section-rewards', selector: '#section-rewards-container', path: 'sections/section-rewards' },
                    { name: 'section-history', selector: '#section-history-container', path: 'sections/section-history' },
                    { name: 'section-admin', selector: '#section-admin-container', path: 'sections/section-admin' },
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–µ–∫—Ü–∏–∏
                    { name: 'section-groups', selector: '#section-groups-container', path: 'sections/section-groups' },
                    { name: 'section-leaderboard', selector: '#section-leaderboard-container', path: 'sections/section-leaderboard' },
                    { name: 'section-challenges', selector: '#section-challenges-container', path: 'sections/section-challenges' },
                    { name: 'section-achievements', selector: '#section-achievements-container', path: 'sections/section-achievements' },
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–±–∏–ª—å–Ω—É—é –Ω–∞–≤–∏–≥–∞—Ü–∏—é
                    { name: 'bottom-navigation', selector: '#bottom-navigation-container', path: 'bottom-navigation' }
                ]);
                appComponentsLoaded = true;
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ñ–æ—Ä–º –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
                console.log("[loadAppComponents] Components loaded, initializing form handlers...");
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –Ω–∞–ª–∏—á–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                const initHandlers = () => {
                    const activityForm = document.getElementById("new-activity-form");
                    const rewardForm = document.getElementById("new-reward-form");
                    const activityBtn = document.getElementById("create-activity-btn");
                    const rewardBtn = document.getElementById("create-reward-btn");
                    
                    console.log("[loadAppComponents] Checking elements (attempt):", {
                        activityForm: !!activityForm,
                        rewardForm: !!rewardForm,
                        activityBtn: !!activityBtn,
                        rewardBtn: !!rewardBtn,
                        createActivity: typeof window.createActivity,
                        createReward: typeof window.createReward,
                        initFormHandlers: typeof window.initFormHandlers,
                        attachFormHandlers: typeof window.attachFormHandlers,
                        attachDirectFormHandlers: typeof window.attachDirectFormHandlers
                    });
                    
                    // –ï—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç—ã –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
                    if (!activityForm || !rewardForm || !activityBtn || !rewardBtn) {
                        console.warn("[loadAppComponents] Forms or buttons not found yet, will retry");
                        return false;
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ—É–Ω–∫—Ü–∏–π
                    if (typeof window.createActivity !== 'function') {
                        console.warn("[loadAppComponents] window.createActivity is not a function yet, will retry");
                        return false;
                    }
                    if (typeof window.createReward !== 'function') {
                        console.warn("[loadAppComponents] window.createReward is not a function yet, will retry");
                        return false;
                    }
                    
                    console.log("[loadAppComponents] All elements and functions found, initializing handlers...");
                    
                    if (typeof window.initFormHandlers === 'function') {
                        console.log("[loadAppComponents] Calling window.initFormHandlers()");
                        window.initFormHandlers();
                    }
                    if (typeof window.attachFormHandlers === 'function') {
                        console.log("[loadAppComponents] Calling window.attachFormHandlers()");
                        window.attachFormHandlers();
                    }
                    if (typeof window.attachDirectFormHandlers === 'function') {
                        console.log("[loadAppComponents] Calling window.attachDirectFormHandlers()");
                        window.attachDirectFormHandlers();
                    }
                    
                    console.log("[loadAppComponents] Form handlers initialization completed successfully!");
                    return true;
                };
                
                // –ü—Ä–æ–±—É–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ —Å —É–≤–µ–ª–∏—á–µ–Ω–∏–µ–º –∑–∞–¥–µ—Ä–∂–µ–∫
                let attempts = 0;
                const maxAttempts = 20; // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫
                const tryInit = () => {
                    attempts++;
                    const success = initHandlers();
                    if (success || attempts >= maxAttempts) {
                        if (!success && attempts >= maxAttempts) {
                            console.error("[loadAppComponents] Failed to initialize form handlers after", maxAttempts, "attempts");
                            console.error("[loadAppComponents] Final state:", {
                                activityForm: !!document.getElementById("new-activity-form"),
                                rewardForm: !!document.getElementById("new-reward-form"),
                                activityBtn: !!document.getElementById("create-activity-btn"),
                                rewardBtn: !!document.getElementById("create-reward-btn"),
                                createActivity: typeof window.createActivity,
                                createReward: typeof window.createReward
                            });
                        } else if (success) {
                            console.log("[loadAppComponents] Successfully initialized form handlers on attempt", attempts);
                        }
                        return;
                    }
                    setTimeout(tryInit, 100 * attempts); // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∑–∞–¥–µ—Ä–∂–∫—É —Å –∫–∞–∂–¥–æ–π –ø–æ–ø—ã—Ç–∫–æ–π
                };
                
                // –ù–∞—á–∏–Ω–∞–µ–º —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏, —á—Ç–æ–±—ã –¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç–∞–º –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è
                setTimeout(tryInit, 100);
            } catch (error) {
                console.error('Error loading app components:', error);
            }
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
        document.addEventListener('DOMContentLoaded', async () => {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º auth –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
            await loadComponent('auth', '#auth-section');
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ñ–æ—Ä–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ü–û–°–õ–ï –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
            if (typeof window.initAuthForms === 'function') {
                window.initAuthForms();
            } else if (typeof initAuthForms === 'function') {
                initAuthForms();
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ü–û–°–õ–ï –∑–∞–≥—Ä—É–∑–∫–∏ auth –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
            applyAuthCheck();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã app-section –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω
            const token = localStorage.getItem('token');
            if (token) {
                await loadAppComponents();
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –≤ body (–≤—Å–µ–≥–¥–∞, –æ–Ω–∏ —Å–∫—Ä—ã—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
            await loadComponents([
                { name: 'modal-edit-activity', selector: 'body', path: 'modals/modal-edit-activity' },
                { name: 'modal-edit-reward', selector: 'body', path: 'modals/modal-edit-reward' },
                { name: 'modal-create-goal', selector: 'body', path: 'modals/modal-create-goal' },
                { name: 'modal-manual-time', selector: 'body', path: 'modals/modal-manual-time' },
                { name: 'modal-day-details', selector: 'body', path: 'modals/modal-day-details' },
                { name: 'modal-child-stats', selector: 'body', path: 'modals/modal-child-stats' },
                { name: 'modal-category', selector: 'body', path: 'modals/modal-category' },
                { name: 'modal-telegram-link', selector: 'body', path: 'modals/modal-telegram-link' },
                { name: 'modal-create-group', selector: 'body', path: 'modals/modal-create-group' },
                { name: 'modal-join-group', selector: 'body', path: 'modals/modal-join-group' },
                { name: 'modal-create-challenge', selector: 'body', path: 'modals/modal-create-challenge' }
            ]);
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
            const modalBaseCSS = document.createElement('link');
            modalBaseCSS.rel = 'stylesheet';
            modalBaseCSS.href = '/static/components/modals/modal-base.css';
            document.head.appendChild(modalBaseCSS);
            
            // –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
            setTimeout(() => {
                applyAuthCheck();
                
                // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                const token = localStorage.getItem('token');
                if (token && typeof window.showApp === 'function') {
                    // –ñ–¥–µ–º –µ—â–µ –Ω–µ–º–Ω–æ–≥–æ, —á—Ç–æ–±—ã –≤—Å–µ –º–æ–¥—É–ª–∏ —Ç–æ—á–Ω–æ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å
                    setTimeout(() => {
                        console.log('[index.html] Auto-loading data for logged in user...');
                        window.showApp();
                    }, 500);
                }
            }, 100);
        });
        
        // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ app.js
        if (typeof window !== 'undefined') {
            window.loadAppComponents = loadAppComponents;
        }
    </script>
    <script>
        // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å–∫—Ä–æ–ª–ª –≤–Ω–∏–∑ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–ø—Ç–æ–≤
        (function() {
            // –£–±–∏—Ä–∞–µ–º —è–∫–æ—Ä—å –∏–∑ URL, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
            if (window.location.hash && window.location.hash !== '#') {
                const hash = window.location.hash;
                window.history.replaceState(null, null, window.location.pathname + window.location.search);
            }
            
            // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –≤–≤–µ—Ä—Ö—É
            window.scrollTo(0, 0);
            document.documentElement.scrollTop = 0;
            document.body.scrollTop = 0;
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏
            setTimeout(() => {
                if (window.scrollY > 0 || document.documentElement.scrollTop > 0) {
                    window.scrollTo(0, 0);
                }
            }, 50);
        })();
    </script>

</body>
</html>
</body>
</html>