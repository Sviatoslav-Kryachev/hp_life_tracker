# История изменений (CHANGELOG)

Все значимые изменения в проекте документируются в этом файле.

Формат основан на [Keep a Changelog](https://keepachangelog.com/ru/1.0.0/).

---

## [2024] - Система целей

### Добавлено
- **Система целей для мотивации пользователей**
  - Модель базы данных `Goal` с полями:
    - Название, описание, целевое количество XP
    - Текущий прогресс (автоматически обновляется)
    - Привязка к активности (опционально) - если указана, учитывается только XP от этой активности
    - Дедлайн (опционально)
    - Статус выполнения
  - API endpoints (`/goals/`):
    - `GET /goals/` - получить все цели пользователя
    - `POST /goals/` - создать новую цель
    - `PUT /goals/{goal_id}` - обновить цель
    - `DELETE /goals/{goal_id}` - удалить цель
    - `POST /goals/{goal_id}/complete` - отметить как выполненную
  - Автоматическое обновление прогресса:
    - При завершении активности прогресс целей обновляется автоматически
    - Если цель привязана к активности, учитывается только XP от этой активности
    - Если не привязана, учитывается весь XP с момента создания цели
    - При достижении цели показывается уведомление
  - UI компоненты:
    - Блок "Мои цели" с красивыми карточками целей
    - Модальное окно для создания цели с выбором активности
    - Прогресс-бары с процентами выполнения
    - Визуальное отображение выполненных целей (зелёный цвет)
    - Кнопки редактирования и удаления
  - Интеграция с админ-панелью:
    - Администратор может видеть цели подопечных в статистике
    - Отображается прогресс каждой цели

### Технические детали
- Файлы: `app/models/base.py` (модель Goal), `app/routers/goals.py`, `app/schemas/goal.py`
- Интеграция: обновление целей в `app/routers/timer.py` при завершении активности
- Frontend: функции `loadGoals()`, `createGoal()`, `deleteGoal()` в `static/app.js`

---

## [2024] - Фиксированная панель заголовка и реорганизация виджетов

### Изменено
- **Панель заголовка (Admin, XP, Logout, Logo) теперь фиксированная**
  - Панель не двигается при скроллинге сайта
  - Используется `fixed top-0 left-0 right-0 z-50`
  - Добавлен отступ `pt-24` для основного контента, чтобы предотвратить перекрытие

### Изменено
- **Виджеты "Сегодня", "Неделя", "Прогресс" перемещены**
  - Виджеты теперь расположены непосредственно под фиксированной панелью заголовка
  - Логичная структура: сначала виджеты, затем остальной контент

### Технические детали
- Файлы: `static/index.html` (изменена структура layout)

---

## [2024] - Исправления UI для карточек наград

### Исправлено
- **Кнопка "Купить" выходит за пределы при прокрутке**
  - Добавлены `flex-shrink-0` и `whitespace-nowrap` к кнопке "Купить"
  - Добавлены responsive классы для скрытия текста "Купить" на маленьких экранах (показывается только иконка)

### Исправлено
- **Иконка редактирования (карандашик) налазит на баллы XP**
  - Уменьшен размер кнопок редактирования/удаления (`w-8 h-8`, `text-[10px]`)
  - Использован `justify-between` для `bottomSection`
  - Добавлен `flex-shrink-0` к `costBadge` для правильного spacing

### Технические детали
- Файлы: `static/app.js` (функция `renderRewardCard`)

---

## [2024] - Админ-панель и система приглашений

### Добавлено
- **Система приглашений для создания дочерних аккаунтов**
  - Каждый пользователь имеет уникальный `invite_code`
  - При регистрации можно указать `invite_code` для связи с родителем
  - Первый зарегистрированный пользователь автоматически становится администратором

### Добавлено
- **Админ-панель для мониторинга подопечных**
  - Кнопка "Admin" в заголовке (видна только администраторам)
  - Список всех подопечных (детей)
  - Статистика каждого подопечного:
    - Общий баланс XP, уровень
    - Серия дней (streak)
    - Статистика за сегодня и неделю
    - История транзакций (заработки и расходы)
    - Список активностей
    - Список целей
  - Генерация и копирование ссылки приглашения

### Добавлено
- **API endpoints для админ-панели** (`/admin/`):
  - `GET /admin/children` - получить список подопечных
  - `GET /admin/invite-code` - получить код приглашения
  - `GET /admin/child/{child_id}/stats` - статистика подопечного
  - `GET /admin/child/{child_id}/history` - история транзакций
  - `GET /admin/child/{child_id}/activities` - список активностей
  - `GET /admin/child/{child_id}/goals` - список целей

### Технические детали
- Файлы: `app/models/base.py` (поля `is_admin`, `parent_id`, `invite_code` в User), `app/routers/admin.py`
- Frontend: функции `showAdminPanel()`, `loadChildren()`, `loadChildStats()` в `static/app.js`

---

## [2024] - Telegram бот интеграция

### Добавлено
- **Telegram бот для быстрого управления**
  - Команда `/start` - регистрация/привязка аккаунта
  - Команда `/xp` - показать текущий баланс XP и уровень
  - Команда `/add_time <минуты> <активность>` - быстрое добавление времени
  - Команда `/report` - отчёт за сегодня
  - Команда `/activities` - список активностей
  - Команда `/help` - справка по командам

### Добавлено
- **Связь Telegram аккаунта с пользователем**
  - Поля `telegram_id` и `telegram_username` в модели User
  - API endpoints `/telegram/link` и `/telegram/unlink` для привязки/отвязки
  - Иконка Telegram в заголовке с прямой ссылкой на бота

### Исправлено
- **Проблемы с event loop и сессиями базы данных**
  - Исправлена ошибка "There is no current event loop in thread 'MainThread'"
  - Правильная обработка асинхронных операций с базой данных
  - Использование `SessionLocal` для каждого запроса

### Технические детали
- Файлы: `app/telegram_bot.py`, `app/routers/telegram.py`, `run_telegram_bot.py`, `test_bot.py`
- Конфигурация: `config.py` для хранения `TELEGRAM_BOT_TOKEN`
- Зависимости: `python-telegram-bot`, `python-dotenv`

---

## [2024] - Система восстановления пароля

### Добавлено
- **Функция "Забыли пароль?"**
  - Модальное окно для запроса кода восстановления
  - Генерация 6-значного кода (в продакшене должен отправляться на email)
  - Endpoint `/auth/forgot-password` для запроса кода
  - Endpoint `/auth/reset-password` для сброса пароля по коду
  - Поля `reset_code` и `reset_code_expires_at` в модели User

### Технические детали
- Файлы: `app/routers/auth.py` (новые endpoints), `static/index.html` (модальное окно), `static/app.js` (функции `showForgotPassword()`, `requestResetCode()`, `resetPassword()`)

---

## [2024] - Система серий (Streak) как в Duolingo

### Добавлено
- **Система серий дней активности**
  - Модель `Streak` для отслеживания:
    - Текущая серия дней
    - Самая длинная серия
    - Последний день активности
    - Всего дней активности
  - Автоматический расчёт бонусов XP за серию:
    - +10% XP за каждые 7 дней подряд
    - +20% XP за каждые 30 дней подряд
  - Виджет "Серия дней" с отображением текущей серии и бонусов
  - Автоматическое обновление при завершении активности

### Технические детали
- Файлы: `app/models/base.py` (модель Streak), `app/routers/streak.py`
- Интеграция: обновление streak в `app/routers/timer.py` при завершении активности
- Frontend: функция `loadStreak()` в `static/app.js`

---

## [2024] - Умные рекомендации

### Добавлено
- **Алгоритм умных рекомендаций**
  - Анализ истории активности пользователя
  - Рекомендации на основе:
    - Продолжения вчерашних активностей ("Ты вчера делал спорт — продолжи серию")
    - Напоминания о забытых активностях ("Ты 4 дня не занимался грамматикой")
    - Популярных активностей
  - Виджет "Умные рекомендации" с кнопками быстрого старта

### Технические детали
- Файлы: `app/routers/recommendations.py`
- Frontend: функция `loadRecommendations()` в `static/app.js`

---

## [2024] - Черный список наград

### Добавлено
- **Система черного списка для наград**
  - Модель `BlacklistReward` для блокировки наград
  - Паттерн-матчинг названий наград (например, "YouTube", "Instagram")
  - Проверка при попытке потратить XP:
    - Если награда в чёрном списке и недостаточно XP - доступ запрещён
    - Показывается предупреждение о необходимости заработать больше XP

### Технические детали
- Файлы: `app/models/base.py` (модель BlacklistReward), `app/routers/blacklist.py`
- Интеграция: проверка в `app/routers/rewards.py` при покупке награды

---

## [2024] - Виджеты и статистика

### Добавлено
- **Виджет "Сегодня"**
  - Заработано XP за сегодня
  - Потрачено XP за сегодня
  - Количество сессий
  - Общее время активности
  - Endpoint `/xp/today` для получения статистики

### Добавлено
- **Мини-календарь недели**
  - Отображение активности по дням недели
  - Визуальная индикация дней с активностью
  - Endpoint `/xp/week` для получения данных

### Добавлено
- **Виджет "Прогресс до следующего уровня"**
  - Прогресс-бар до следующего уровня
  - Отображение текущего и следующего уровня
  - Мотивационные сообщения

### Добавлено
- **История доходов/расходов**
  - Список всех транзакций (заработки и расходы)
  - Фильтрация по типу
  - Endpoint `/xp/history` для получения истории

### Технические детали
- Файлы: `app/routers/xp.py` (новые endpoints), `static/app.js` (функции `loadTodayStats()`, `loadWeekCalendar()`, `loadHistory()`)

---

## [2024] - Улучшения UI для наград

### Изменено
- **Современный дизайн блока наград**
  - Градиентные фоны для карточек
  - Бренд-специфичные стили (McDonald's, YouTube, Instagram и т.д.)
  - Иконки для популярных наград
  - Улучшенная типографика

### Добавлено
- **Быстрый выбор наград**
  - Секция "Быстрый выбор" с предустановленными наградами
  - Кнопки для быстрого добавления популярных наград
  - Красивые hover-эффекты с кольцевой подсветкой вокруг иконок

### Исправлено
- **Текст награды обрезался**
  - Убраны `overflow-hidden` и `min-w-0` из контейнера текста
  - Добавлен `break-words` для переноса длинных названий
  - Улучшена структура карточки: название сверху, XP и кнопки снизу

### Изменено
- **Расположение элементов в карточке награды**
  - Иконка и название сверху
  - XP badge и кнопки (Купить, Редактировать, Удалить) снизу
  - Кнопки редактирования/удаления всегда видны
  - Кнопка редактирования - зелёная, удаления - красная
  - Убраны hover-эффекты масштабирования, вызывающие смещение элементов

### Технические детали
- Файлы: `static/index.html`, `static/app.js` (функция `renderRewardCard()`, `getRewardBrandInfo()`), `static/style.css`

---

## [2024] - Полноценная аутентификация

### Добавлено
- **JWT-аутентификация**
  - Использование JSON Web Tokens для авторизации
  - Токены хранятся в localStorage браузера
  - Автоматическая проверка токена при загрузке страницы

### Добавлено
- **Защита всех API endpoints**
  - Все endpoints (кроме `/auth/register` и `/auth/login`) требуют авторизации
  - Dependency `get_current_user` для проверки токена
  - Возврат 401 Unauthorized при невалидном токене

### Добавлено
- **UI для входа/регистрации**
  - Форма входа с email и паролем
  - Форма регистрации
  - Переключение между вкладками "Вход" и "Регистрация"
  - Кнопка выхода из аккаунта

### Исправлено
- **Проблема с JWT токенами**
  - Исправлена ошибка "Subject must be a string" - теперь `sub` в токене всегда строка
  - Правильная конвертация `user.id` в строку при создании токена
  - Правильная конвертация обратно в int при декодировании

### Технические детали
- Файлы: `app/utils/auth.py` (функции для работы с JWT), `app/routers/auth.py` (endpoints регистрации/входа)
- Frontend: функции `login()`, `register()`, `logout()`, `checkAuth()` в `static/app.js`
- Зависимости: `python-jose[cryptography]` для работы с JWT

---

## [2024] - Исправление расчёта XP для коротких сессий

### Исправлено
- **XP не начислялся за сессии менее 1 минуты**
  - Проблема: `duration_minutes` приводился к `int()`, что обрезало дробные минуты до 0
  - Решение: использование `total_seconds() / 60` для точного расчёта дробных минут
  - Теперь XP начисляется даже за несколько секунд активности

### Технические детали
- Файлы: `app/routers/timer.py` (функция `stop_timer()`)

---

## [2024] - Начальная версия проекта

### Добавлено
- Базовая структура FastAPI приложения
- Модели базы данных: User, XPWallet, Activity, ActivityLog, Reward, TimerLog
- API endpoints для:
  - Управления активностями
  - Управления наградами
  - Таймера активности
  - Кошелька XP
- Frontend интерфейс с Tailwind CSS
- Интеграция с базой данных SQLite

---

## Как использовать этот файл

Этот файл документирует все значимые изменения в проекте. Каждая запись включает:
- **Дату/версию** (если применимо)
- **Тип изменения**: Добавлено, Изменено, Исправлено, Удалено
- **Описание** изменений
- **Технические детали** с указанием затронутых файлов

При добавлении новых функций или исправлении багов, пожалуйста, обновляйте этот файл.

